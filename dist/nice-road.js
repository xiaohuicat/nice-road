var u=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var f=u((fr,z)=>{var T=require("fs"),F=require("path"),Se=require("ioredis");function Te(t){return t==null}function Ae(t){return typeof t=="object"&&!Array.isArray(t)&&t!==null}function be(t){try{return T.existsSync(t)?T.statSync(t).isFile():!1}catch(e){return console.error("Error checking file:",e),!1}}function Re(t,e){if(!(!t||!e))for(let r in e)typeof e[r]=="function"?t[r]=e[r].bind(t):t[r]=e[r]}function ke(t){return new Promise(e=>{T.readFile(t,"utf8",(r,n)=>{if(r){e(null);return}e(n)})})}var Pe=async t=>new Promise(e=>{let r=[];T.readdir(t,(n,i)=>{if(n)throw console.error("\u8BFB\u53D6router\u6587\u4EF6\u5939\u5931\u8D25 routerPath:",t);i.forEach(function(s){let{urls:o,rules:a}=require(F.join(t,s));if(!o)throw console.error("\u6CA1\u6709\u627E\u5230urls\uFF0C\u8BF7\u5728\u6587\u4EF6\u4E2D\u4F7F\u7528module.exports\u66B4\u9732urls");o.forEach(c=>{c&&(a&&!c?.rules&&(c.rules=a),r.indexOf(c)==-1&&r.push(c))})}),e(r)})});function Ce(t,e="text/plain"){if(!t)return"unknown";var r={css:"text/css",gif:"image/gif",html:"text/html",ico:"image/x-icon",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",pdf:"application/pdf",png:"image/png",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",xml:"text/xml"},n=F.extname(t);n=n?n.slice(1):"unknown";var i=r[n]??e;return i}function L(t){return t&&t.constructor&&t.constructor.name==="AsyncFunction"}function N(t){return t instanceof Promise||t!==null&&typeof t=="object"&&typeof t.then=="function"}function V(t,...e){return new Promise(r=>{if(N(t)||L(t))t(...e).then(n=>{r({status:!0,data:n})}).catch(n=>{r({status:!1,msg:n?.message||n})});else try{let n=t(...e);r({status:!0,data:n})}catch(n){r({status:!1,msg:n?.message||n})}})}async function je(t){let e=new Se;await V(t,e),e.quit()}z.exports={isNull:Te,isObject:Ae,isFile:be,isPromise:N,isAsyncFunction:L,addProperty:Re,readFile:ke,getRouters:Pe,getContentTypeByPath:Ce,safeRunCallback:V,redisEasy:je}});var A=u((pr,K)=>{var H=require("url"),{getContentTypeByPath:G}=f();function Ue(t){let e=this;return new Promise(r=>{let n="";e.on("data",function(i){n+=i}),e.on("end",function(){t=t||{};try{Object.assign(t,JSON.parse(n))}catch{}r(t)})})}function Be(){let t=this;return new Promise((e,r)=>{let n=t.headers["content-type"].split("; ")[1].replace("boundary=",""),i="",s={},o=[];t.on("data",a=>{i+=a}),t.on("end",()=>{let a=i.split(`--${n}`);for(let c of a)if(c&&c!==`--\r
`){let[l,...y]=c.split(`\r
\r
`),S=y.join(`\r
\r
`).trim();if(l.includes("filename")){let w=l.match(/filename="(.+)"/)[1],xe=l.match(/Content-Type: (.+)/)[1];o.push({filename:w,mimetype:xe,buffer:Buffer.from(S,"binary")})}else{let w=l.match(/name="(.+)"/)[1];s[w]=S}}e({fields:s,files:o})}),t.on("error",a=>{r(a)})})}function De(){return this?.headers?.authorization}function ve(t="unknow"){let e=this;return e.headers["x-forwarded-for"]||e?.connection?.remoteAddress||e?.socket?.remoteAddress||e?.connection?.socket?.remoteAddress||t}function Oe(){let e=this.reqUrl;return e?G(e):"unknown"}function Ie(){let t=this,e={};return t.headers.cookie&&t.headers.cookie.split(";").forEach(function(r){var n=r.match(/(.*?)=(.*)$/);e[n[1].trim()]=(n[2]||"").trim()}),e}function Me(){let t=this,e=H.parse(t.url).query;if(!e)return{};let r=e.indexOf("&")>-1?e.split("&"):[e],n={};for(each of r){let i=each.indexOf("=")>-1?each.split("="):!1;i&&(n[i[0]]=i[1])}return n}function Fe(){let e=this.url,r=H.parse(e).pathname;return r=decodeURI(r),G(r,"error")!=="error"||r.endsWith("/")?r:r+"/"}function Le(){return this.method}function Ne(t){return this.method===t.toUpperCase()}function Ve(t){let e=this?.ruleResult?.params??{};return t?e?.[t]:e}K.exports={getBody:Ue,getFiles:Be,getToken:De,getClientIp:ve,getContentType:Oe,getCookies:Ie,getQuery:Me,getReqUrl:Fe,getMethod:Le,isMethod:Ne,getUser:Ve}});var b=u((dr,W)=>{var ze=require("fs"),{isObject:He,isFile:Ge,getContentTypeByPath:Ke}=f();function Je(t){let e=this,r;return He(t)?(t=JSON.stringify(t),r="application/json"):r="text/plain",e.writeHead(200,{"Content-Type":`${r}`}),e.end(t),!0}function We(t){let e=this;return e.writeHead(200,{"Content-Type":"application/json"}),e.end(JSON.stringify(t)),!0}function J(t,e=200,r=!0){let n=this;if(!Ge(t))return n.writeHead(404,{"Content-Type":"text/html"}),n.end('<body type="font-size:32px;color:purple;">error 404</body>'),!1;let i=Ke(t);n.writeHead(e,{"content-type":i,"Cache-Control":"public, max-age=31536000, immutable",Expires:new Date(Date.now()+31536e3*1e3).toUTCString()});let s=ze.createReadStream(t);s.on("error",function(){return n.writeHead(500,{"Content-Type":"text/html"}),n.end('<body type="font-size:32px;color:purple;">error 500</body>'),!1}),s.on("close",()=>(n.end(),!0)),s.pipe(n)}W.exports={send:Je,sendFile:J,sendJson:We,sendStreamFile:J}});var j=u((yr,$)=>{var{getBody:$e,getClientIp:Qe,getContentType:Ye,getCookies:Xe,getQuery:Ze,getReqUrl:et,isMethod:tt,getUser:rt}=A(),{send:nt,sendJson:st,sendFile:it,sendStreamFile:ot}=b(),{redisEasy:ct}=f();$.exports={getBody:$e,getClientIp:Qe,getContentType:Ye,getCookies:Xe,getQuery:Ze,getReqUrl:et,isMethod:tt,getUser:rt,send:nt,sendJson:st,sendFile:it,sendStreamFile:ot,redisEasy:ct}});var q=u((mr,ee)=>{var d=require("path"),Q=require("fs"),{isObject:Y}=f(),p={};function at(){return p}function X(t){let e=d.join(t,"databases"),r=d.join(t,"users"),n=d.join(t,"templates"),i=d.join(t,"public"),s=d.join(t,"pages"),o=d.join(t,"resources"),a=d.join(t,"/RSA/private_pem.txt"),c=d.join(t,"/RSA/public_pem.txt");return{STATIC_URL:t,DB_URL:e,USER_URL:r,TEMPLATES_URL:n,PUBLIC_URL:i,PAGES_URL:s,RESOURCE_URL:o,PRIVATE_PEM_PATH:a,PUBLIC_PEM_PATH:c}}function Z(t){if(!Y(t))throw new Error("Mysql config must be an object.");let{host:e="127.0.0.1",port:r=3360,database:n="database",timezone:i="+08:00",username:s,password:o}=t;if(!s)throw new Error("Username is required.");if(!o)throw new Error("Password is required.");if(!e)throw new Error("Host cannot be empty.");if(!r)throw new Error("Port cannot be empty.");if(!n)throw new Error("Database name cannot be empty.");if(!i)throw new Error("Timezone cannot be empty.");return{host:e,port:r,database:n,username:s,password:o,timezone:i}}function ut(t){if(!Y(t))throw new Error("setting must be an object.");for(let e in t)e==="mysqlConfig"||e==="staticPath"||(p[e]=t[e]);if("staticPath"in t){let e=X(t.staticPath);for(let r in e)p[r]=e[r]}if("mysqlConfig"in t){let e=Z(t.mysqlConfig);p.MYSQL_CONFIG=e}return p?.PRIVATE_PEM_PATH&&Q.existsSync(p?.PRIVATE_PEM_PATH)&&(p.PRIVATE_PEM=Q.readFileSync(p?.PRIVATE_PEM_PATH)),p}ee.exports={createStaticPath:X,createMysqlConfig:Z,getSetting:at,applySetting:ut}});var U=u((hr,te)=>{var m=require("crypto-js"),R=require("crypto"),{Buffer:_}=require("buffer");function lt(){return R.randomBytes(32).toString("base64")}function ft(t,e){try{let r=_.from(e,"base64"),n=R.randomBytes(12),i=R.createCipheriv("aes-256-gcm",r,n),s=i.update(t,"utf8","base64");s+=i.final("base64");let o=i.getAuthTag();return _.concat([n,_.from(s,"base64"),o]).toString("base64")}catch(r){return console.error("\u52A0\u5BC6\u9519\u8BEF:",r),null}}function pt(t,e){try{try{let i=_.from(e,"base64"),s=_.from(t,"base64"),o=s.slice(0,12),a=s.slice(s.length-16),c=s.slice(12,s.length-16),l=R.createDecipheriv("aes-256-gcm",i,o);l.setAuthTag(a);let y=l.update(c,void 0,"utf8");return y+=l.final("utf8"),y}catch(i){console.warn("GCM\u89E3\u5BC6\u5931\u8D25\uFF0C\u5C1D\u8BD5\u65E7\u7248ECB\u6A21\u5F0F:",i.message);var r=m.enc.Utf8.parse(e),n=m.AES.decrypt({ciphertext:m.enc.Utf8.parse(t)},r,{mode:m.mode.ECB,padding:m.pad.Pkcs7});return n.toString(m.enc.Utf8)}}catch(i){return console.error("\u89E3\u5BC6\u9519\u8BEF:",i),null}}te.exports={aes_generate_key:lt,aes_encrypt:ft,aes_decrypt:pt}});var B=u((gr,re)=>{var E=require("crypto");function dt(){let{generateKeyPairSync:t}=E,{publicKey:e,privateKey:r}=t("rsa",{modulusLength:2048,publicKeyEncoding:{type:"pkcs1",format:"pem"},privateKeyEncoding:{type:"pkcs1",format:"pem"}});return{privateKey:r,publicKey:e}}function yt(t,e){return E.publicEncrypt({key:t,padding:E.constants.RSA_PKCS1_OAEP_PADDING,oaepHash:"sha256"},Buffer.from(e)).toString("base64")}function mt(t,e){return E.privateDecrypt({key:t,padding:E.constants.RSA_PKCS1_OAEP_PADDING,oaepHash:"sha256"},Buffer.from(e,"base64")).toString("utf-8")}re.exports={rsa_generate_keys:dt,rsa_decrypt:mt,rsa_encrypt:yt}});var v=u((wr,se)=>{var ne=require("jsonwebtoken"),D=class{constructor(e){this.jwt_key=e}encrypt(e,r){return ne.sign(e,this.jwt_key,{expiresIn:r})}decrypt(e){try{return{status:!0,msg:"\u6709\u6548token",data:ne.verify(e,this.jwt_key)}}catch{return{status:!1,msg:"\u65E0\u6548token"}}}};se.exports={Token:D}});var I=u((qr,ce)=>{var{aes_decrypt:ht}=U(),{rsa_decrypt:gt}=B(),{Token:wt}=v(),{isPromise:qt,isAsyncFunction:_t,isNull:k}=f();function O(t){if(!Array.isArray(t))throw new Error("conditions\u53C2\u6570\u5FC5\u987B\u4E3A\u6570\u7EC4");let e=!1,r="",n;for(let i=0;i<t.length;i++){let s=t[i];if(typeof s=="function"){let{fail:o,msg:a,params:c}=s(n);e=o,r=a,n=c}else Array.isArray(s)&&s.length===2?(e=s[0],r=s[1]):(e=s?.fail,r=s?.msg);if(e)break}return{fail:e,msg:r,params:n}}async function Et(t){if(!Array.isArray(t))throw new Error("conditions\u53C2\u6570\u5FC5\u987B\u4E3A\u6570\u7EC4");let e=!1,r="",n;for(let i=0;i<t.length;i++){let s=t[i];if(typeof s=="function"){let{fail:o,msg:a,params:c}=_t(s)?await s(n):s(n);e=o,r=a,n=c}else if(qt(s)){let{fail:o,msg:a,params:c}=await s(n);e=o,r=a,n=c}else Array.isArray(s)&&s.length===2?(e=s[0],r=s[1]):(e=s?.fail,r=s?.msg);if(e)break}return{fail:e,msg:r,params:n}}function h(t,e){let r={fail:!1};return k(t)||(r.msg=t),k(e)||(r.params=e),r}function g(t,e){let r={fail:!0};return k(t)||(r.msg=t),k(e)||(r.params=e),r}function xt(t,e){try{let r=t.slice(0,344),n=t.slice(344,1024),i=gt(e,r),s=i.slice(-13),o=i.slice(0,-13);if(Date.now()-s>1e3*30)return!1;let c=ht(n,o);return h("rsa\u89E3\u5BC6\u6210\u529F",c)}catch{return g("rsa\u89E3\u5BC6\u5931\u8D25")}}function ie(t,e="jwt"){let r=new wt(e).decrypt(t,"utf8");return r.status?h("jwt\u89E3\u5BC6\u6210\u529F",r.data):g(r?.msg??"jwt\u89E3\u5BC6\u5931\u8D25")}function oe(t,e="jwt",r){let{fail:n,params:i,msg:s}=O([[!t,"token\u4E3A\u7A7A"],()=>r&&!t.includes("[no-rsa]")?xt(t,r):h("\u65E0\u9700rsa\u89E3\u5BC6",t),o=>ie(o?.replace("[no-rsa]",""),e)]);return n?g(s,i):h(s,i)}function St(t,{token:e,method:r,jwt_key:n,rsa_private_pem:i}){return O([[t==="NO","\u65E0\u9700\u6821\u9A8C"],[t.includes("GET")&&r!=="GET","\u8BF7\u6C42\u65B9\u6CD5\u9519\u8BEF"],[t.includes("POST")&&r!=="POST","\u8BF7\u6C42\u65B9\u6CD5\u9519\u8BEF"],()=>{let s;if(t.includes("USER")||t.includes("ADMIN")){let{fail:o,params:a,msg:c}=oe(e,n,i);if(o)return g(c);s=a}return t.includes("ADMIN")&&s?.role!=="\u7BA1\u7406\u5458"?g("\u65E0\u8BBF\u95EE\u6743\u9650"):h("\u6821\u9A8C\u901A\u8FC7",s)}])}ce.exports={rule:St,multipleValidate:O,asyncMultipleValidate:Et,ruleNext:h,ruleBreak:g,jwtVerify:ie,userRSAVerify:oe}});var pe=u((_r,fe)=>{var Tt=require("fs"),At=require("http"),ae=require("path"),{isObject:ue,getRouters:bt,addProperty:le}=f(),{getReqUrl:Rt,send:kt}=j(),Pt=A(),Ct=b(),{applySetting:jt}=q(),{rule:Ut}=I();function Bt(t,e){for(let r=0;r<t.length;r++)if(t[r].endsWith("*")?e.startsWith(t[r].replace("*","")):e===t[r])return r;return-1}var M=class{constructor(e){this.routers=[],this.urls=[],this.rule=Ut,this.reqBindsDict={...Pt},this.resBindsDict={...Ct},e&&jt(e)}addRule(e){return typeof e=="function"?(this.rule=e,!0):!1}async initRouter(e){if(!e)throw console.error("routerPath is null");if(!ae.isAbsolute(e)&&(e=ae.join(process.cwd(),e),!Tt.existsSync(e))){console.error("routerPath is not exists");return}this.routers=await bt(e),this.urls=[],this.routers.forEach(r=>{if(!r||!r.url)return;if(r.url.endsWith("*")){this.urls.push(r.url);return}let n=r.url.endsWith("/")?r.url:r.url+"/";this.urls.push(n)})}#e(e,r){e.getReqUrl=Rt;let n=e.getReqUrl(),i=Bt(this.urls,n);if(i==-1){r.send=kt,r.send({status:!1,msg:"url not found"});return}le(e,this.reqBindsDict),le(r,this.resBindsDict),this.routers[i]?.run?.(e,r,this.rule)}reqBinds(e){ue(e)&&Object.keys(e).forEach(r=>{this.reqBindsDict[r]=e[r]})}resBinds(e){ue(e)&&Object.keys(e).forEach(r=>{this.resToolsDict[r]=e[r]})}run(e=2023,r=null){this.httpServer=At.createServer((i,s)=>this.#e(i,s)),this.port=e;let n=()=>{console.log(`app is running at port:${e}`),console.log(`url: http://localhost:${e}`)};this.httpServer.listen(e,typeof r=="function"?r:n)}};fe.exports={NiceRoad:M}});var he=u((Er,me)=>{var{getSetting:ye}=q(),{safeRunCallback:de}=f(),x=class{constructor(e,r,n){this.url=e,this.callback=r,this.rules=n}async run(e,r,n){if(!this.url||!this.callback){console.error("[warning]\u9519\u8BEF\u7684\u8DEF\u7531");return}let{__DEV__:i,JWT_KEY:s,PRIVATE_PEM:o}=ye();if(!this.rules){let{status:S,msg:w}=await de(this.callback,e,r);S||r.send({status:!1,msg:i?w:"\u53D1\u751F\u9519\u8BEF\uFF01"});return}let a={token:e.getToken(),method:e.getMethod(),jwt_key:s,rsa_private_pem:o},c=await n(this.rules,a);if(c?.fail){r.send({status:!1,msg:c?.msg||"verify error"});return}e.ruleResult=c;let{status:l,msg:y}=await de(this.callback,e,r);l||r.send({status:!1,msg:i?y:"\u53D1\u751F\u9519\u8BEF\uFF01"})}};function Dt(t,e,r){let{__DEV__:n,URL_PREFIX:i}=ye();if(t.startsWith("[hard]")){let o=t.replace("[hard]","");return n&&console.log(`[info]\u6CE8\u518C\u8DEF\u7531\uFF1A${o}`),new x(o,e,r)}let s=i+t;return n&&console.log(`[info]\u6CE8\u518C\u8DEF\u7531\uFF1A${s}`),new x(s,e,r)}me.exports={Router:x,npath:Dt}});var qe=u((xr,we)=>{var C=require("sequelize"),{getSetting:vt}=q(),P;function ge(){if(P)return P;let{database:t,username:e,password:r,host:n,port:i,timezone:s,pool:o}=vt().MYSQL_CONFIG;if(!t||!e||!r||!n||!i)throw new Error("database config error");return P=new C(t,e,r,{host:n,port:i,dialect:"mysql",timezone:s,pool:o}),P}async function Ot(){try{return await ge().sync(),{status:!0,msg:"\u6570\u636E\u5E93\u540C\u6B65\u6210\u529F"}}catch(t){return{status:!1,msg:t?.message||t}}}we.exports={useSequelize:ge,syncSequelize:Ot,Sequelize:C,DataTypes:C.DataTypes,Op:C.Op}});var Ee=u((Sr,_e)=>{var{aes_generate_key:It,aes_encrypt:Mt,aes_decrypt:Ft}=U(),{rsa_generate_keys:Lt,rsa_decrypt:Nt,rsa_encrypt:Vt}=B();_e.exports={aes_generate_key:It,aes_encrypt:Mt,aes_decrypt:Ft,rsa_generate_keys:Lt,rsa_decrypt:Nt,rsa_encrypt:Vt}});var{NiceRoad:zt}=pe(),{npath:Ht}=he(),{useSequelize:Gt,syncSequelize:Kt,Sequelize:Jt,DataTypes:Wt,Op:$t}=qe(),{reqTools:Qt}=A(),{resTools:Yt}=b(),Xt=j(),Zt=f(),er=v(),tr={...Zt,Token:er},{rule:rr,ruleBreak:nr,ruleNext:sr,multipleValidate:ir,asyncMultipleValidate:or}=I(),cr=Ee(),{applySetting:ar,getSetting:ur}=q();module.exports={NiceRoad:zt,npath:Ht,reqTools:Qt,resTools:Yt,httpTools:Xt,tools:tr,crypt:cr,applySetting:ar,getSetting:ur,useSequelize:Gt,syncSequelize:Kt,DataTypes:Wt,Sequelize:Jt,Op:$t,rule:rr,ruleBreak:nr,ruleNext:sr,multipleValidate:ir,asyncMultipleValidate:or};
