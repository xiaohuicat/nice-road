var o=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var l=o((Bt,T)=>{var m=require("fs"),C=require("path"),se=require("ioredis");function ne(e){return typeof e=="object"&&!Array.isArray(e)&&e!==null}function ie(e){return m.existsSync(e)&&m.statSync(e).isFile()}function ae(e,t){if(!(!e||!t))for(let r in t)typeof t[r]=="function"?e[r]=t[r].bind(e):e[r]=t[r]}function oe(e){return new Promise(t=>{m.readFile(e,"utf8",(r,s)=>{if(r){t(null);return}t(s)})})}var ue=async e=>new Promise(t=>{let r=[];m.readdir(e,(s,n)=>{if(s)throw console.error("\u8BFB\u53D6router\u6587\u4EF6\u5939\u5931\u8D25 routerPath:",e);n.forEach(function(i){let{urls:a,rules:c}=require(C.join(e,i));if(!a)throw console.error("\u6CA1\u6709\u627E\u5230urls\uFF0C\u8BF7\u5728\u6587\u4EF6\u4E2D\u4F7F\u7528module.exports\u66B4\u9732urls");a.forEach(f=>{c&&!f.rules&&(f.rules=c),r.indexOf(f)==-1&&r.push(f)})}),t(r)})});function ce(e){if(!e)return"unknown";var t={css:"text/css",gif:"image/gif",html:"text/html",ico:"image/x-icon",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",pdf:"application/pdf",png:"image/png",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",xml:"text/xml"},r=C.extname(e);r=r?r.slice(1):"unknown";var s=t[r]||"text/plain";return s}function le(e){return e&&e.constructor&&e.constructor.name==="AsyncFunction"}function pe(e){return e instanceof Promise||e!==null&&typeof e=="object"&&typeof e.then=="function"}function R(e,...t){return new Promise(r=>{if(pe(e)||le(e))e(...t).then(s=>{r({status:!0,data:s})}).catch(s=>{r({status:!1,msg:s?.message||s})});else try{let s=e(...t);r({status:!0,data:s})}catch(s){r({status:!1,msg:s?.message||s})}})}async function fe(e){let t=new se;await R(e,t),t.quit()}T.exports={isObject:ne,isFile:ie,addProperty:ae,readFile:oe,getRouters:ue,getContentTypeByPath:ce,safeRunCallback:R,redisEasy:fe}});var g=o((At,A)=>{var B=require("url"),{getContentTypeByPath:de}=l();function ye(){let e=this;return new Promise(t=>{let r="";e.on("data",function(s){r+=s}),e.on("end",function(){try{r=JSON.parse(r)}catch{r={}}t(r)})})}function he(){let e=this;return e.headers["x-forwarded-for"]||e?.connection?.remoteAddress||e?.socket?.remoteAddress||e?.connection?.socket?.remoteAddress||"unknow"}function me(){let t=this.reqUrl;return t?de(t):"unknown"}function ge(){let e=this;var t={};return e.headers.cookie&&e.headers.cookie.split(";").forEach(function(r){var s=r.match(/(.*?)=(.*)$/);t[s[1].trim()]=(s[2]||"").trim()}),t}function qe(){let e=this;var t=B.parse(e.url).query;if(!t)return{};var r=t.indexOf("&")>-1?t.split("&"):[t],s={};for(each of r){var n=each.indexOf("=")>-1?each.split("="):!1;n&&(s[n[0]]=n[1])}return s}function we(){var t=this.url,r=B.parse(t).pathname,r=decodeURI(r);return r=="/"?"/":r.endsWith("/")?r:r+"/"}function xe(){return this.method}function _e(e){return this.method===e.toUpperCase()}A.exports={getBody:ye,getClientIp:he,getContentType:me,getCookies:ge,getQuery:qe,getReqUrl:we,getMethod:xe,isMethod:_e}});var q=o((Dt,E)=>{var ve=require("fs"),{isObject:Se,isFile:ke,getContentTypeByPath:je}=l();function be(e){let t=this,r;return Se(e)?(e=JSON.stringify(e),r="application/json"):r="text/plain",t.writeHead(200,{"Content-Type":r}),t.end(e),!0}function Ce(e){let t=this;return t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify(e)),!0}function D(e,t=200){let r=this;if(!ke(e))return r.writeHead(404,{"Content-Type":"text/html"}),r.end('<body type="font-size:32px;color:purple;">error 404</body>'),!1;let s=je(e);r.writeHead(t,{"content-type":s});let n=ve.createReadStream(e);n.on("error",function(){return r.writeHead(404,{"Content-Type":"text/html"}),r.end('<body type="font-size:32px;color:purple;">error 404</body>'),!1}),n.on("close",()=>(r.end(),!0)),n.pipe(r)}E.exports={send:be,sendFile:D,sendJson:Ce,sendStreamFile:D}});var x=o((Et,P)=>{var{getBody:Re,getClientIp:Te,getContentType:Be,getCookies:Ae,getQuery:De,getReqUrl:Ee,isMethod:Pe}=g(),{send:Oe,sendJson:Ue,sendFile:Fe,sendStreamFile:ze}=q(),{redisEasy:Ke}=l();P.exports={getBody:Re,getClientIp:Te,getContentType:Be,getCookies:Ae,getQuery:De,getReqUrl:Ee,isMethod:Pe,send:Oe,sendJson:Ue,sendFile:Fe,sendStreamFile:ze,redisEasy:Ke}});var _=o((Pt,O)=>{var u=require("crypto-js");function He(){return u.randomBytes(32)}function Me(e,t){var r=u.enc.Utf8.parse(t),s=u.enc.Utf8.parse(e),n=u.AES.encrypt(s,r,{mode:u.mode.ECB,padding:u.pad.Pkcs7});return n.toString()}function Ne(e,t){var r=u.enc.Utf8.parse(t),s=u.AES.decrypt(e,r,{mode:u.mode.ECB,padding:u.pad.Pkcs7});return u.enc.Utf8.stringify(s).toString()}O.exports={aes_generate_key:He,aes_encrypt:Me,aes_decrypt:Ne}});var v=o((Ot,U)=>{var y=require("crypto");function Ie(){let{generateKeyPairSync:e}=y,{publicKey:t,privateKey:r}=e("rsa",{modulusLength:2048,publicKeyEncoding:{type:"pkcs1",format:"pem"},privateKeyEncoding:{type:"pkcs1",format:"pem"}});return{privateKey:r,publicKey:t}}function Je(e,t){return y.publicEncrypt({key:e,padding:y.constants.RSA_PKCS1_OAEP_PADDING,oaepHash:"sha256"},Buffer.from(t)).toString("base64")}function Le(e,t){return y.privateDecrypt({key:e,padding:y.constants.RSA_PKCS1_OAEP_PADDING,oaepHash:"sha256"},Buffer.from(t,"base64")).toString("utf-8")}U.exports={rsa_generate_keys:Ie,rsa_decrypt:Le,rsa_encrypt:Je}});var k=o((Ut,z)=>{var F=require("jsonwebtoken"),S=class{constructor(t){this.jwt_key=t}encrypt(t,r){return F.sign(t,this.jwt_key,{expiresIn:r})}decrypt(t){try{return{status:!0,msg:"\u6709\u6548token",data:F.verify(t,this.jwt_key)}}catch{return{status:!1,msg:"\u65E0\u6548token"}}}};z.exports={Token:S}});var M=o((Ft,H)=>{var{aes_decrypt:Ge}=_(),{rsa_decrypt:$e}=v(),{Token:K}=k(),{redisEasy:Qe}=l();function We(e,t="jwt",r){if(!e)return!1;if(r&&!e.includes("[no-rsa]"))try{let s=e.slice(0,344),n=e.slice(344,1024),i=$e(req.rsa_private_pem,s),a=i.slice(0,16),c=i.slice(16,100);if(Date.now()-c>1e3*30)return!1;let d=Ge(n,a);return result=K(t).decrypt(d),result.status?result.data:!1}catch{return!1}return result=K(t).decrypt(e.replace("[no-rsa]",""),"utf8"),result.status?result.data:!1}function Ve(e,{method:t,jwt_key:r,rsa_private_pem:s}){return new Promise(async n=>{let i;if(e=="no"){n({status:!0,message:"\u901A\u8FC7\u9A8C\u8BC1",verify:i});return}if(e.includes("get")&&t!=="GET"){n({status:!1,message:"\u8BF7\u6C42\u65B9\u6CD5\u9519\u8BEF"});return}if(e.includes("post")&&t!=="POST"){n({status:!1,message:"\u8BF7\u6C42\u65B9\u6CD5\u9519\u8BEF"});return}if((e.includes("user")||e.includes("admin")||e.includes("supervision"))&&(i=We(token,r,s),!i)){n({status:!1,message:"\u8BBF\u95EE\u5185\u5BB9\u9700\u767B\u5F55"});return}if(e.includes("admin")&&i.role!="\u7BA1\u7406\u5458"&&n({status:!1,message:"\u65E0\u8BBF\u95EE\u6743\u9650"}),e.includes("supervision")){let a=i.role,c=i.user_id;if(a=="\u8003\u6838\u7EC4"||a=="\u7BA1\u7406\u5458"){if(a!="\u7BA1\u7406\u5458"){if(!((await Qe(async d=>await d.lrange("supervision",0,-1))).filter(d=>d==c).length>0)){n({status:!1,message:"\u8003\u6838\u7EC4\u6210\u5458\uFF0C\u9700\u7533\u8BF7\u6743\u9650"});return}}}else{n({status:!1,message:"\u975E\u8003\u6838\u7EC4\u6210\u5458\uFF0C\u65E0\u8BBF\u95EE\u6743\u9650"});return}}n({status:!0,message:"\u901A\u8FC7\u9A8C\u8BC1",verify:i})})}H.exports={rule:Ve}});var G=o((zt,L)=>{var j=require("fs"),Xe=require("http"),N=require("path"),{isObject:I,getRouters:Ye,addProperty:J,safeRunCallback:Ze}=l(),{getReqUrl:et,send:tt}=x(),rt=g(),st=q(),{rule:nt}=M();async function it(e,t,r){let s=!0;for(let n of r){let{status:i,msg:a,data:c}=await Ze(n,e,t);if(!i){s=!1,console.error("\u8FD0\u884C\u4E2D\u95F4\u4EF6\u51FA\u9519\uFF1A",a),t.send({status:!1,msg:"middleware error"});break}if(!c){s=!1;break}}return s}var at=(e,t,r)=>{let s;r?.rsa_private_path&&j.existsSync(r.rsa_private_path)&&(s=j.readFileSync(r.rsa_private_path));let{jwt_key:n}=r;return i=>e(i,{method:t,jwt_key:n,rsa_private_pem:s})},b=class{constructor(t){this.setting=t,this.routers=[],this.urls=[],this.rule=nt,this.reqBindsDict={...rt},this.resBindsDict={...st},this.middlewareList=[]}addMiddleware(t){return typeof t=="function"?(this.middlewareList.push(t),!0):!1}setRule(t){return typeof t=="function"?(this.rule=t,!0):!1}initRouter=async t=>{if(!t)throw console.error("routerPath is null");if(!N.isAbsolute(t)&&(t=N.join(process.cwd(),t),!j.existsSync(t))){console.error("routerPath is not exists");return}this.routers=await Ye(t),this.urls=this.routers.map(r=>r.url=="/"?"/":r.url.endsWith("/")?r.url:r.url+"/")};enter=async(t,r)=>{t.getReqUrl=et;let s=t.getReqUrl(),n=this.urls.indexOf(s);if(n==-1){r.send=tt,r.send({status:!1,msg:"url not found"});return}J(t,this.reqBindsDict),J(r,this.resBindsDict),await it(t,r,this.middlewareList)&&this.routers[n]?.run?.(t,r,at(this?.rule,t?.getMethod(),this?.setting))};reqBinds(t){I(t)&&Object.keys(t).forEach(r=>{this.reqBindsDict[r]=t[r]})}resBinds(t){I(t)&&Object.keys(t).forEach(r=>{this.resToolsDict[r]=t[r]})}run(t=2023,r=null){this.httpServer=Xe.createServer(this.enter),this.port=t;let s=()=>{console.log(`app is running at port:${t}`),console.log(`url: http://localhost:${t}`)};this.httpServer.listen(t,r||s)}};L.exports={NiceRoad:b}});var W=o((Kt,Q)=>{var{safeRunCallback:$}=l(),h=class{constructor(t,r,s){this.url=t,this.callback=r,this.rules=s}async run(t,r,s){if(!this.url||!this.callback){console.error("[warning]\u9519\u8BEF\u7684\u8DEF\u7531");return}if(!this.rules){let{status:i,msg:a}=await $(this.callback,t,r);i||r.send({status:!0,msg:a});return}let n=await s(this.rules);if(n?.status){t.ruleResult=n;let{status:i,msg:a}=await $(this.callback,t,r);i||r.send({status:!0,msg:a});return}else{r.send({status:!1,msg:n?.message||"verify error"});return}}};function ot(e,t,r){if(typeof e=="string"&&typeof t=="function")return new h(e,t,r);if(typeof e=="object"&&typeof t>"u")return new h(e?.url,e?.callback,e?.rules);console.error("[warning]\u9519\u8BEF\u7684\u8DEF\u7531\u914D\u7F6E")}Q.exports={npath:ot,Router:h}});var X=o((Ht,V)=>{var p=require("path");function ut(e){let t=p.join(e,"databases"),r=p.join(e,"users"),s=p.join(e,"templates"),n=p.join(e,"public"),i=p.join(e,"pages"),a=p.join(e,"/RSA/private_pem.txt"),c=p.join(e,"/RSA/public_pem.txt");return{static_url:e,db_url:t,user_url:r,templates_url:s,public_url:n,pages_url:i,private_pem_path:a,public_pem_path:c}}V.exports={createStaticPath:ut}});var ee=o((Mt,Z)=>{var Y=require("sequelize"),w;function ct(e){return w||(w=new Y(e.database,e.username,e.password,{host:e.host,port:e.port,dialect:"mysql",timezone:e.timezone,pool:{max:5,min:0,idle:3e4}}),w)}Z.exports={createSequelize:ct,Sequelize:Y}});var re=o((Nt,te)=>{var{aes_generate_key:lt,aes_encrypt:pt,aes_decrypt:ft}=_(),{rsa_generate_keys:dt,rsa_decrypt:yt,rsa_encrypt:ht}=v();te.exports={aes_generate_key:lt,aes_encrypt:pt,aes_decrypt:ft,rsa_generate_keys:dt,rsa_decrypt:yt,rsa_encrypt:ht}});var{NiceRoad:mt}=G(),{npath:gt,Router:qt}=W(),{createStaticPath:wt}=X(),{createSequelize:xt,Sequelize:_t}=ee(),{reqTools:vt}=g(),{resTools:St}=q(),kt=x(),jt=l(),bt=k(),Ct={...jt,Token:bt},Rt=re();module.exports={NiceRoad:mt,Router:qt,npath:gt,reqTools:vt,resTools:St,httpTools:kt,tools:Ct,crypt:Rt,createStaticPath:wt,createSequelize:xt,Sequelize:_t};
